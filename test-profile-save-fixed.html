<!DOCTYPE html>
<html>
<head>
    <title>Profile Save Test - Fixed</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Profile Save Test - Fixed</h1>
    <div id="status">Loading...</div>
    <button onclick="testProfileSave()">Test Profile Save</button>
    
    <script>
        const SUPABASE_URL = "https://gjvxcisbaxhhblhsytar.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqdnhjaXNiYXhoaGJsaHN5dGFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwNjU4MDUsImV4cCI6MjA2NzY0MTgwNX0.p4HO2McB5IqP9iQ_p_Z6yHKCkKyDXuIm7ono6UJZcmM";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        async function testProfileSave() {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = 'Testing profile save...';
            
            try {
                // First, try to sign in anonymously
                const { data: authData, error: authError } = await supabase.auth.signInAnonymously();
                
                if (authError) {
                    statusDiv.innerHTML = 'Auth error: ' + authError.message;
                    return;
                }
                
                console.log('Authenticated as:', authData.user);
                
                // Try to update a profile (without ai_opt_out field)
                const { data: updateData, error: updateError } = await supabase
                    .from('profiles')
                    .update({
                        first_name: 'Test',
                        last_name: 'User',
                        phone: '+1234567890',
                        date_of_birth: '1990-01-01',
                        medical_history: 'None',
                        address: '123 Test St',
                        emergency_contact: 'Emergency Contact'
                    })
                    .eq('user_id', authData.user.id)
                    .select();
                
                if (updateError) {
                    statusDiv.innerHTML = 'Profile update error: ' + updateError.message;
                    return;
                }
                
                console.log('Profile updated:', updateData);
                statusDiv.innerHTML = 'Profile save test successful! Updated fields: ' + JSON.stringify(updateData);
                
            } catch (error) {
                statusDiv.innerHTML = 'Error: ' + error.message;
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>